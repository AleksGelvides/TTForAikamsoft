# Тестовое задание Aikamsoft
***
## Начало работы
Для запуска приложения необходимо иметь базу данных. Что бы её запустить и наполнить выполните команды на выгруженном из *GitHub* проекте:

1) В файле `src/main/resources/db-connection.yaml` укажите доступы к вашей БД.

2) Разверните базу данных: `docker run --name postgres -p 5433:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=postgres -d postgres:14` - эта команда нужна для развертывания базы данных в контейнере *Docker*
3) `mvn liquibase:update` - эта команда нужна для того, что бы заполнить базу данных.

### Обратите внимание: для запуска проекта необходим **maven 4.0.0**  

---
## Жизненный цикл

### **Входные и выходные данные**

При запуске приложения необходимо передать 2 параметра:
`search` для поиска покупателей по разным условиям.

EXAMPLE:
```
{
"criterias": [
    {"lastName": "Иванов"}, //Фамилия
    {"productName": "Минеральная вода", "minTimes": 5}, //Название товара и число раз
    {"minExpenses": 112, "maxExpenses": 4000}, //Минимальная и максимальная стоимость всех покупок
    {"badCustomers": 3} //Число пассивных покупателей
    ]
}
```
И полный путь до JSON файла с запросом с *критериями поиска*.

Или для получения статистики так же нужно передать 2 параметра: `stat` для получения статистики по покупателям и товарам, которые они приобретали за определенный промежуток времени.

EXAMPLE:
```
{
    "startDate": "2020-01-14", // Начальная дата
    "endDate": "2020-01-26" // Конечная дата
}
```

Выходной JSON файл с ошибками или обработанными запросами будут находится в том каталоге, где и входные.

**Пример запуска приложения:** `java -jar app.jar stat /fullPath/stat_input.json` 

**Обратите внимание:** постфикс `_input` **обязателен**, т.к выходной файл будет формироваться с `_output`.

### **How it work**
Принцип работы приложения:

1) *Main* метод вызывает созданный в основном классе ***DataService*** и передает в него параметр и путь к json файлу.
2) Внутри ***DataService*** производится чтение файла и преобразование его в строку за счет написанного класса ***IOManager***
3) Строка с JSON передается в ***JsonHandler*** задача которого получить все ***Criteria*** или объект ***Statistic*** исходя из запроса, и сформировать ***InputData*** объект с коллекцией наследников абстрактного класса ***Criteria*** или ***Statistic***. *Более подробное формирование наследников можно посмотреть в самом классе Criteria*.
4) Далее происходит обращение к репозиторию написанном с использованием JDBC и SQL запросов в каталоге: `src/main/java/dbcommon/`. Процесс работы репозитория следующий:
   
   1) Создается объект ***JDBConnector***, который позволяет подключиться к БД.
   2) Создается объект с конкретными запросами ***SqlReader***
   3) ***Repository*** работает с указанными выше объектами и достает из базы данных ту информацию, которую мы попросим.

5) На выходе из репозитория мы получаем коллекции с объектами, которые соответсвуют нашим запросам.
6) Внутри ***DataService*** формируется ***Response*** который возвращет нам результат запроса `stat` или `search`, так же этот объект возвращает ошибку, если таковая будет сформирована.

**Тонкости работы:**

*Объекты наследники класса `Criteria` создаются за счет передаваемых JSON внутри билдера написанного в самом классе `Criteria`.*

*Класс `Statistic` и класс `Criteria` наследуются от класса `InputData`, при этом внутри класса `InputData` лежит коллекция с критериями, но нет коллекции с `Statistic`. Это обусловенно усложнением кода.*


 *К сожалению, я пока не смог запустить программу из отдельного jar файла из-за ошибки с JDBC драйвером Postgresql. - Активно над этим работаю.*

