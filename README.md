# Тестовое задание Aikamsoft
***
Тестовое задание от компании **Aikamsoft**. Продробные требования описанны в _**Тестовое задание.docx**_
## Начало работы
### Сборка проекта
Для запуска приложения необходимо иметь базу данных. Что бы её запустить и наполнить выполните команды на выгруженном из *GitHub* проекте:
1) Перейдите в каталог с выгруженным из _**GH**_ проектом.
2) В файле `src/main/resources/db-connection.yaml` укажите доступы к вашей БД.

3) Разверните базу данных: `docker run --name postgres -p 5433:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=postgres -d postgres:14` - эта команда нужна для развертывания базы данных в контейнере *Docker* (Обратите внимание, у вас не должно быть контейнера с таким именем). Если у вас есть какая-то тестовая ДБ, просто пропустите этот шаг.
4) После чего выполните `mvn liquibase:update compile package` - эта команда нужна для того, что бы заполнить базу данных и собрать проект из исходников.
#### Обратите внимание: проект тестировался с **maven 3.8.6**

### Тестирование проекта.
В корневом каталоге проекта "`/TEForAikamsoft/`" выполните команды:
* `java -jar target/TEforAikamsoft-1.0-SNAPSHOT.jar search jsons/test_search_input.json` для выполнения поиска по разным критериям, которые описаны ниже.
* `java -jar target/TEforAikamsoft-1.0-SNAPSHOT.jar stat jsons/test_stat_input.json ` для получения статистики за определенный интервал дат.

При запуске приложения указываются 2 параметра:
* `search` - указывает программе, что мы ищем покупателей по определенным критериям, которые указали во входном JSON. Пример JSON ниже.
* `stat` - указывает программе, что нам нужна статистика по датам. Вернет JSON со всеми покупателями и покупками за определенный период.

**Обратите внимание:** постфикс `_input` **обязателен**, т.к выходной файл будет формироваться с `_output`.

#### Обратите внимание: Если при запросе интервала статистики не будет полезной информации - это значит, что в этот период не было покупок. Данное поведение обусловленно случайной генерацией записей в таблице покупок, в Liquibase.

---
## Зависимости
Основные зависимости для успешного запуска проложения:
* Java 8
* Maven 3.8.6
* Docker Desktop 4.9.1

---
## Жизненный цикл

### **Входные и выходные данные**

#### Пример JSON для `search`:
```
{
"criterias": [
    {"lastName": "Иванов"}, //Фамилия
    {"productName": "Минеральная вода", "minTimes": 5}, //Название товара и число раз
    {"minExpenses": 112, "maxExpenses": 4000}, //Минимальная и максимальная стоимость всех покупок
    {"badCustomers": 3} //Число пассивных покупателей
    ]
}
```
И полный путь до JSON файла с запросом с *критериями поиска*.

Или для получения статистики так же нужно передать 2 параметра: `stat` для получения статистики по покупателям и товарам, которые они приобретали за определенный промежуток времени.

#### Пример JSON для `stat`:
```
{
    "startDate": "2020-01-14", // Начальная дата
    "endDate": "2020-01-26" // Конечная дата
}
```

Выходной JSON файл с ошибками или обработанными запросами будут находится в том каталоге, где и входные.

### Входные данные для JSON из ДБ

#### Buyers:

ID |  Name   | Last Name
---|:-------:|:-------:
1| Андрей  |Смирнов
2| Виктор  |Смирнов
3| Евгений |Смирнов
4| Сергей  |Смирнов
5|Евгений|Ширяев
6|Александр|Макаров
7|Елена|Свиридова
8|Антон|Гущин
9|Анастасия|Антонова
10|Григорий|Денисов
11|Юлия|Сергеева
12|Антонина|Бах
13|Виктория|Изотова

#### Products:
ID |  Price   | Product Name
---|:--------:|:-------:
1| 10000.99 |Стол
2|  39900   |Компьютер
3|  700.65  |Раковина
4| 12500.55 |Кровать
5| 12000.99 |Кофеварка
6|   7.5    |Мотыга
7|  430.22  |Пачка карандашей
8|  990.99  |Светильник
9|  333.99  |Подушка


## **How it work**
Принцип работы приложения:

1) *Main* метод вызывает созданный в основном классе ***DataService*** и передает в него параметр и путь к json файлу.
2) Внутри ***DataService*** производится чтение файла и преобразование его в строку за счет написанного класса ***IOManager***
3) Строка с JSON передается в ***JsonHandler*** задача которого получить все ***Criteria*** или объект ***Statistic*** исходя из запроса, и сформировать ***InputData*** объект с коллекцией наследников абстрактного класса ***Criteria*** или ***Statistic***. *Более подробное формирование наследников можно посмотреть в самом классе Criteria*.
4) Далее происходит обращение к репозиторию написанном с использованием JDBC и SQL запросов в каталоге: `src/main/java/dbcommon/`. Процесс работы репозитория следующий:
   
   1) Создается объект ***JDBConnector***, который позволяет подключиться к БД.
   2) Создается объект с конкретными запросами ***SqlReader***
   3) ***Repository*** работает с указанными выше объектами и достает из базы данных ту информацию, которую мы попросим.

5) На выходе из репозитория мы получаем коллекции с объектами, которые соответсвуют нашим запросам.
6) Внутри ***DataService*** формируется ***Response*** который возвращет нам результат запроса `stat`, `search` или `error`, если таковая будет сформирована.

**Тонкости работы:**

* Объекты наследники класса `Criteria` создаются за счет передаваемых JSON внутри билдера написанного в самом классе `Criteria`.*

* Класс `Statistic` и класс `Criteria` наследуются от класса `InputData`, при этом внутри класса `InputData` лежит коллекция с критериями, но нет коллекции с `Statistic`. Это обусловенно усложнением кода.*
* Все объекты, которые мапятся в JSON содержат в себе имплементацию `Response`, это используется для быстрого и простого создания выходного JSON.
